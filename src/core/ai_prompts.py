"""
AIæ€»ç»“åŠŸèƒ½çš„Promptæ¨¡æ¿
ä¸“é—¨é’ˆå¯¹MediaWikiæŠ€æœ¯é—®é¢˜è®¨è®ºçš„æ€»ç»“
"""

from datetime import datetime
from typing import List, Dict


class MediaWikiSummaryPrompts:
    """MediaWikiæŠ€æœ¯é—®é¢˜æ€»ç»“çš„Promptæ¨¡æ¿"""
    
    @staticmethod
    def get_daily_summary_prompt(messages: List[Dict], date: str) -> str:
        """
        ç”Ÿæˆæ¯æ—¥MediaWikiæŠ€æœ¯é—®é¢˜æ€»ç»“çš„prompt
        
        Args:
            messages: æ¶ˆæ¯åˆ—è¡¨ï¼Œæ¯ä¸ªæ¶ˆæ¯åŒ…å«æ—¶é—´ã€å‘é€è€…ã€å†…å®¹ç­‰
            date: æ€»ç»“çš„æ—¥æœŸ
            
        Returns:
            å®Œæ•´çš„promptå­—ç¬¦ä¸²
        """
        
        # æ„å»ºæ¶ˆæ¯å†…å®¹ï¼Œä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
        messages_text = ""
        for msg in messages:
            time_str = msg.get('time', '')  # æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
            username = msg.get('username', f"ç”¨æˆ·{msg.get('user_id', 0)}")
            message = msg.get('message', '')
            datetime_str = msg.get('datetime', '')  # å®Œæ•´çš„æ—¥æœŸæ—¶é—´
            
            # ä½¿ç”¨æ›´æ¸…æ™°çš„æ ¼å¼
            messages_text += f"[{datetime_str}] {username}: {message}\n"
        
        # ç»Ÿè®¡åŸºæœ¬ä¿¡æ¯
        total_messages = len(messages)
        unique_users = len(set(msg.get('username', '') for msg in messages))
        
        prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¾¤èŠå†…å®¹åˆ†æå¸ˆã€‚è¯·åˆ†æä»¥ä¸‹{date}çš„ç¾¤èŠè®°å½•ï¼Œå…±{total_messages}æ¡æ¶ˆæ¯ï¼Œ{unique_users}äººå‚ä¸è®¨è®ºã€‚

ç¾¤èŠè®°å½•ï¼š
{messages_text}

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¿›è¡Œæ€»ç»“ï¼š

## ğŸ“Š ä»Šæ—¥è®¨è®ºæ¦‚è§ˆ
- æ€»æ¶ˆæ¯æ•°ï¼š{total_messages}æ¡
- å‚ä¸è®¨è®ºäººæ•°ï¼š{unique_users}äºº
- ä¸»è¦è®¨è®ºæ—¶é—´æ®µï¼š[æ ¹æ®æ¶ˆæ¯æ—¶é—´åˆ†ææ´»è·ƒæ—¶æ®µ]

## ğŸ’¬ ä¸»è¦è¯é¢˜
è¯·è¯†åˆ«å¹¶æ€»ç»“è®¨è®ºä¸­çš„ä¸»è¦è¯é¢˜ï¼ŒæŒ‰é‡è¦æ€§æ’åºï¼š

### è¯é¢˜1ï¼š[è¯é¢˜æ ‡é¢˜]
- **è®¨è®ºå†…å®¹**ï¼š[ç®€è¦æè¿°è®¨è®ºçš„æ ¸å¿ƒå†…å®¹]
- **å‚ä¸è€…**ï¼š[ä¸»è¦å‚ä¸è®¨è®ºçš„ç”¨æˆ·]
- **å…³é”®è§‚ç‚¹**ï¼š[è®¨è®ºä¸­çš„é‡è¦è§‚ç‚¹æˆ–ç»“è®º]
- **è®¨è®ºçƒ­åº¦**ï¼š[é«˜/ä¸­/ä½ï¼ŒåŸºäºæ¶ˆæ¯æ•°é‡å’Œå‚ä¸åº¦]

### è¯é¢˜2ï¼š[è¯é¢˜æ ‡é¢˜]
[åŒä¸Šæ ¼å¼ï¼Œå¦‚æœæœ‰å¤šä¸ªè¯é¢˜çš„è¯]

## ğŸ” æŠ€æœ¯é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
å¦‚æœè®¨è®ºä¸­æ¶‰åŠæŠ€æœ¯é—®é¢˜ï¼Œè¯·åˆ—å‡ºï¼š

### é—®é¢˜ï¼š[é—®é¢˜æè¿°]
- **é—®é¢˜è¯¦æƒ…**ï¼š[å…·ä½“é—®é¢˜æè¿°]
- **è§£å†³æ–¹æ¡ˆ**ï¼š[è®¨è®ºä¸­æåˆ°çš„è§£å†³æ–¹æ¡ˆ]
- **çŠ¶æ€**ï¼š[å·²è§£å†³/è®¨è®ºä¸­/å¾…è·Ÿè¿›]

## ğŸ¯ é‡ç‚¹ä¿¡æ¯
- **æœ€æ´»è·ƒçš„è®¨è®º**ï¼š[å‚ä¸äººæ•°æœ€å¤šæˆ–æ¶ˆæ¯æœ€å¤šçš„è¯é¢˜]
- **é‡è¦å†³å®šæˆ–ç»“è®º**ï¼š[å¦‚æœæœ‰è¾¾æˆå…±è¯†æˆ–åšå‡ºå†³å®š]
- **éœ€è¦è·Ÿè¿›çš„äº‹é¡¹**ï¼š[æœªå®Œæˆæˆ–éœ€è¦åç»­å¤„ç†çš„å†…å®¹]

## ğŸ‘¥ æ´»è·ƒç”¨æˆ·
- **å‘è¨€æœ€å¤š**ï¼š[å‘è¨€æ¬¡æ•°æœ€å¤šçš„ç”¨æˆ·åŠå‘è¨€æ•°]
- **è´¡çŒ®çªå‡º**ï¼š[æä¾›æœ‰ä»·å€¼ä¿¡æ¯æˆ–è§£å†³æ–¹æ¡ˆçš„ç”¨æˆ·]

## ğŸ“ å…¶ä»–å€¼å¾—å…³æ³¨çš„å†…å®¹
[å…¶ä»–æœ‰ä»·å€¼çš„è®¨è®ºå†…å®¹ã€æœ‰è¶£çš„è¯é¢˜æˆ–é‡è¦ä¿¡æ¯]

è¯·ç¡®ä¿æ€»ç»“å†…å®¹å®¢è§‚å‡†ç¡®ï¼Œçªå‡ºé‡ç‚¹ï¼Œå¦‚æœå½“å¤©è®¨è®ºå†…å®¹è¾ƒå°‘æˆ–ä¸»è¦æ˜¯æ—¥å¸¸èŠå¤©ï¼Œè¯·å¦‚å®åæ˜ ã€‚"""

        return prompt
    
    @staticmethod
    def get_weekly_summary_prompt(summaries: List[str], week_range: str) -> str:
        """
        ç”Ÿæˆå‘¨æ€»ç»“çš„prompt
        
        Args:
            summaries: æ¯æ—¥æ€»ç»“åˆ—è¡¨
            week_range: å‘¨èŒƒå›´
            
        Returns:
            å‘¨æ€»ç»“prompt
        """
        
        summaries_text = "\n\n".join([f"## {i+1}æ—¥æ€»ç»“\n{summary}" for i, summary in enumerate(summaries)])
        
        prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„MediaWikiæŠ€æœ¯é—®é¢˜åˆ†æå¸ˆã€‚è¯·åŸºäºä»¥ä¸‹{week_range}çš„æ¯æ—¥æ€»ç»“ï¼Œç”Ÿæˆå‘¨æ€»ç»“æŠ¥å‘Šã€‚

æ¯æ—¥æ€»ç»“å†…å®¹ï¼š
{summaries_text}

è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç”Ÿæˆå‘¨æ€»ç»“ï¼š

## ğŸ“Š æœ¬å‘¨æŠ€æœ¯è®¨è®ºæ¦‚è§ˆ
- æ€»è®¨è®ºå¤©æ•°ï¼šXå¤©
- æ€»é—®é¢˜æ•°ï¼šXä¸ª
- å·²è§£å†³é—®é¢˜ï¼šXä¸ª
- å¾…è§£å†³é—®é¢˜ï¼šXä¸ª

## ğŸ”¥ æœ¬å‘¨çƒ­ç‚¹é—®é¢˜
[åˆ—å‡ºæœ¬å‘¨è®¨è®ºæœ€çƒ­çƒˆçš„é—®é¢˜]

## ğŸ¯ é—®é¢˜åˆ†ç±»ç»Ÿè®¡
- **æ‰©å±•é—®é¢˜**ï¼šXä¸ª
- **æ¨¡æ¿é—®é¢˜**ï¼šXä¸ª
- **æƒé™é—®é¢˜**ï¼šXä¸ª
- **æ€§èƒ½é—®é¢˜**ï¼šXä¸ª
- **å…¶ä»–é—®é¢˜**ï¼šXä¸ª

## ğŸ† æœ¬å‘¨æŠ€æœ¯äº®ç‚¹
[æ€»ç»“æœ¬å‘¨çš„æŠ€æœ¯åˆ›æ–°å’Œè§£å†³æ–¹æ¡ˆ]

## ğŸ“ˆ è¶‹åŠ¿åˆ†æ
- **é—®é¢˜è¶‹åŠ¿**ï¼š[é—®é¢˜ç±»å‹çš„å˜åŒ–è¶‹åŠ¿]
- **æŠ€æœ¯å‘å±•**ï¼š[æŠ€æœ¯è®¨è®ºçš„å‘å±•æ–¹å‘]
- **ç”¨æˆ·æ´»è·ƒåº¦**ï¼š[ç”¨æˆ·å‚ä¸åº¦çš„å˜åŒ–]

## ğŸ”® ä¸‹å‘¨å…³æ³¨é‡ç‚¹
[åŸºäºæœ¬å‘¨è®¨è®ºï¼Œé¢„æµ‹ä¸‹å‘¨å¯èƒ½å…³æ³¨çš„æŠ€æœ¯é—®é¢˜]

è¯·ç¡®ä¿å‘¨æ€»ç»“å…·æœ‰å‰ç»æ€§å’ŒæŒ‡å¯¼æ€§ã€‚"""

        return prompt


class SummaryTemplates:
    """æ€»ç»“æ¨¡æ¿ç±»"""
    
    @staticmethod
    def format_message_for_ai(message_data: Dict) -> str:
        """
        æ ¼å¼åŒ–æ¶ˆæ¯æ•°æ®ä¸ºAIå¯è¯»çš„æ ¼å¼
        
        Args:
            message_data: æ¶ˆæ¯æ•°æ®å­—å…¸
            
        Returns:
            æ ¼å¼åŒ–åçš„æ¶ˆæ¯å­—ç¬¦ä¸²
        """
        timestamp = message_data.get('time', '')
        sender = message_data.get('sender', '')
        content = message_data.get('content', '')
        message_type = message_data.get('type', 'text')
        
        if message_type == 'text':
            return f"[{timestamp}] {sender}: {content}"
        elif message_type == 'image':
            return f"[{timestamp}] {sender}: [å‘é€äº†å›¾ç‰‡]"
        elif message_type == 'file':
            return f"[{timestamp}] {sender}: [å‘é€äº†æ–‡ä»¶: {content}]"
        else:
            return f"[{timestamp}] {sender}: [{message_type}æ¶ˆæ¯]"
    
    @staticmethod
    def create_summary_filename(date: datetime) -> str:
        """
        åˆ›å»ºæ€»ç»“æ–‡ä»¶å
        
        Args:
            date: æ—¥æœŸå¯¹è±¡
            
        Returns:
            æ–‡ä»¶å
        """
        return f"summary_{date.strftime('%Y%m%d')}.md"
    
    @staticmethod
    def create_weekly_summary_filename(start_date: datetime, end_date: datetime) -> str:
        """
        åˆ›å»ºå‘¨æ€»ç»“æ–‡ä»¶å
        
        Args:
            start_date: å¼€å§‹æ—¥æœŸ
            end_date: ç»“æŸæ—¥æœŸ
            
        Returns:
            æ–‡ä»¶å
        """
        return f"weekly_summary_{start_date.strftime('%Y%m%d')}_{end_date.strftime('%Y%m%d')}.md"
