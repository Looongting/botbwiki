# 群消息总结功能使用指南

## 功能概述

群消息总结插件是一个智能化的群聊内容分析工具，能够自动提取群聊中的技术答疑和知识共享内容，并按主题进行整理和总结。

## 主要特性

- **智能识别**: 自动识别技术相关的讨论内容
- **主题合并**: 将相同主题的讨论内容合并整理
- **结构化输出**: 生成标准JSON格式的总结报告
- **批量处理**: 支持批量总结多天的群消息
- **历史查看**: 可随时查看已生成的总结结果
- **数据持久化**: 自动保存原始记录和总结结果

## 命令说明

### 1. 群总结命令

**语法**: `群总结 [日期]`

**功能**: 总结指定日期的群消息

**参数**:
- `日期` (可选): 目标日期，支持以下格式：
  - `YYYY-MM-DD`: 具体日期，如 `2024-01-15`
  - `今天`: 今天的消息
  - `昨天`: 昨天的消息
  - 不指定: 默认总结昨天的消息

**示例**:
```
群总结                    # 总结昨天的消息
群总结 2024-01-15        # 总结指定日期的消息
群总结 今天              # 总结今天的消息
群总结 昨天              # 总结昨天的消息
```

### 2. 批量总结命令

**语法**: `批量总结 <天数>`

**功能**: 批量总结最近N天的群消息

**参数**:
- `天数`: 要总结的天数，范围1-30

**示例**:
```
批量总结 7               # 批量总结最近7天的消息
批量总结 30              # 批量总结最近30天的消息
```

### 3. 查看总结命令

**语法**: `查看总结 [日期]`

**功能**: 查看指定日期的总结结果

**参数**:
- `日期` (可选): 目标日期，格式同群总结命令

**示例**:
```
查看总结                 # 查看昨天的总结结果
查看总结 2024-01-15      # 查看指定日期的总结结果
查看总结 今天            # 查看今天的总结结果
```

## 数据存储

### 目录结构
```
./data/
├── history/                    # 原始聊天记录
│   ├── {群ID}-{日期}.json     # 原始消息数据
│   └── ...
└── historySummary/             # 总结结果
    ├── {群ID}-{日期}-summary.json  # 总结数据
    └── ...
```

### 文件格式

#### 原始记录格式 (`./data/history/{群ID}-{日期}.json`)
```json
[
  {
    "message_id": 123456,
    "user_id": 789012,
    "time": 1705123456,
    "message_type": "text",
    "content": "消息内容"
  }
]
```

#### 总结结果格式 (`./data/historySummary/{群ID}-{日期}-summary.json`)
```json
{
  "group_id": 123456789,
  "date": "2024-01-15",
  "summary": [
    {
      "name": "Python异步编程讨论",
      "方案": [
        "使用asyncio库进行异步编程",
        "async/await语法是核心",
        "aiohttp可用于异步HTTP请求"
      ]
    },
    {
      "name": "数据库优化建议",
      "方案": [
        "添加适当的索引提高查询性能",
        "使用连接池减少连接开销",
        "定期清理无用数据"
      ]
    }
  ],
  "created_at": "2024-01-16T10:30:00",
  "message_count": 25
}
```

## 使用流程

### 1. 首次使用
1. 确保机器人已正确配置AI服务
2. 在群内发送 `群总结` 命令测试功能
3. 查看返回结果确认功能正常

### 2. 日常使用
1. **单日总结**: 使用 `群总结 [日期]` 总结特定日期的消息
2. **批量总结**: 使用 `批量总结 <天数>` 批量处理多天消息
3. **查看结果**: 使用 `查看总结 [日期]` 查看已生成的总结

### 3. 数据管理
- 原始记录和总结结果会自动保存到 `./data/` 目录
- 可以定期清理旧数据以节省存储空间
- 建议定期备份重要的总结数据

## 注意事项

### 1. 权限要求
- 机器人需要群管理员权限才能获取群历史消息
- 确保机器人在目标群中具有足够的权限

### 2. 性能考虑
- 大量消息的总结可能需要较长时间
- 建议在群聊活跃度较低时进行批量总结
- 单次批量总结建议不超过30天

### 3. 数据隐私
- 总结功能会保存群聊的原始记录
- 请确保符合相关隐私政策和法律法规
- 建议定期清理敏感数据

### 4. AI服务依赖
- 功能依赖AI服务的可用性
- 建议配置多个AI服务作为备用
- 网络问题可能影响AI总结质量

## 故障排查

### 常见问题

1. **"获取历史消息失败"**
   - 检查机器人是否有群管理员权限
   - 确认群ID是否正确
   - 检查HTTP API连接是否正常

2. **"AI总结失败"**
   - 检查AI服务配置是否正确
   - 确认API密钥是否有效
   - 检查网络连接是否正常

3. **"未找到总结文件"**
   - 确认是否已运行过群总结命令
   - 检查日期格式是否正确
   - 确认数据目录是否存在

### 调试方法

1. **查看日志**: 检查机器人运行日志中的错误信息
2. **测试连接**: 使用 `?ai_test` 命令测试AI服务
3. **手动测试**: 运行 `tools/test_group_summary.py` 进行功能测试

## 配置要求

### 环境变量
```bash
# AI服务配置
LONGCAT_API_KEY=your_longcat_api_key_here
ARK_API_KEY=your_volc_api_key_here

# AI功能配置
DEFAULT_AI_SERVICE=longcat
AI_SUMMARY_MAX_TOKENS=2000
AI_SUMMARY_TIMEOUT=30
```

### 系统要求
- Python 3.8+
- 足够的存储空间用于保存历史记录
- 稳定的网络连接用于AI服务调用

## 更新日志

### v1.0.0 (2024-01-16)
- 初始版本发布
- 支持单日和批量群消息总结
- 支持查看历史总结结果
- 自动数据持久化存储
