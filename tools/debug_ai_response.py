#!/usr/bin/env python3
"""
è°ƒè¯•AIå“åº”å†…å®¹
"""

import asyncio
import sys
import os

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from src.core.ai_manager import ai_manager


async def debug_ai_response():
    """è°ƒè¯•AIå“åº”"""
    print("ğŸ” è°ƒè¯•AIå“åº”å†…å®¹...\n")
    
    # æµ‹è¯•ç®€å•çš„æ¶ˆæ¯
    test_messages = [
        {"role": "user", "content": "ä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±"}
    ]
    
    print("1ï¸âƒ£ æµ‹è¯•ç®€å•å¯¹è¯...")
    result = await ai_manager.chat_completion(test_messages)
    print(f"AIå›å¤: '{result}'")
    print(f"å›å¤é•¿åº¦: {len(result) if result else 0}")
    print()
    
    # æµ‹è¯•ç¾¤èŠæ€»ç»“
    test_chat = """[10:30:15] ç”¨æˆ·123456: å¤§å®¶å¥½ï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹Pythonçš„å¼‚æ­¥ç¼–ç¨‹æ€ä¹ˆç”¨ï¼Ÿ
[10:31:20] ç”¨æˆ·789012: å¯ä»¥ç”¨asyncioåº“ï¼Œasync/awaitè¯­æ³•
[10:32:05] ç”¨æˆ·123456: èƒ½ä¸¾ä¸ªå…·ä½“ä¾‹å­å—ï¼Ÿ
[10:33:10] ç”¨æˆ·789012: æ¯”å¦‚è¿™æ ·ï¼šasync def main(): await asyncio.sleep(1)
[10:34:15] ç”¨æˆ·345678: è¿˜æœ‰aiohttpå¯ä»¥ç”¨æ¥åšå¼‚æ­¥HTTPè¯·æ±‚
[10:35:20] ç”¨æˆ·123456: è°¢è°¢å¤§å®¶ï¼Œæˆ‘è¯•è¯•çœ‹"""
    
    prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯å†…å®¹åˆ†æå¸ˆã€‚è¯·åˆ†æä»¥ä¸‹ç¾¤èŠè®°å½•ï¼Œæå–å…¶ä¸­çš„æŠ€æœ¯ç­”ç–‘å’ŒçŸ¥è¯†å…±äº«å†…å®¹ã€‚

åˆ†æè¦æ±‚ï¼š
1. è¯†åˆ«æ‰€æœ‰æŠ€æœ¯ç›¸å…³çš„è®¨è®ºå†…å®¹ï¼ˆç¼–ç¨‹ã€å·¥å…·ä½¿ç”¨ã€é—®é¢˜è§£å†³ç­‰ï¼‰
2. å°†ç›¸åŒä¸»é¢˜çš„å†…å®¹åˆå¹¶åˆ°ä¸€èµ·
3. æå–å…·ä½“çš„è§£å†³æ–¹æ¡ˆã€å»ºè®®å’ŒçŸ¥è¯†ç‚¹
4. å¿½ç•¥çº¯é—²èŠã€è¡¨æƒ…åŒ…ã€é—®å€™ç­‰éæŠ€æœ¯å†…å®¹
5. æ¯ä¸ªä¸»é¢˜è¦åŒ…å«æ¸…æ™°çš„åç§°å’Œå…·ä½“çš„æ–¹æ¡ˆåˆ—è¡¨

ç¾¤èŠè®°å½•ï¼š
{test_chat}

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
[
  {{
    "name": "å…·ä½“çš„æŠ€æœ¯ä¸»é¢˜åç§°",
    "æ–¹æ¡ˆ": [
      "å…·ä½“çš„è§£å†³æ–¹æ¡ˆæˆ–çŸ¥è¯†ç‚¹1",
      "å…·ä½“çš„è§£å†³æ–¹æ¡ˆæˆ–çŸ¥è¯†ç‚¹2"
    ]
  }}
]

å¦‚æœç¾¤èŠä¸­æ²¡æœ‰æŠ€æœ¯å†…å®¹ï¼Œè¯·è¿”å›ç©ºæ•°ç»„ï¼š[]"""
    
    print("2ï¸âƒ£ æµ‹è¯•ç¾¤èŠæ€»ç»“...")
    summary_messages = [
        {"role": "user", "content": prompt}
    ]
    
    result = await ai_manager.chat_completion(summary_messages)
    print(f"AIå›å¤: '{result}'")
    print(f"å›å¤é•¿åº¦: {len(result) if result else 0}")
    
    if result:
        print("\nğŸ“Š å›å¤å†…å®¹åˆ†æ:")
        print(f"   æ˜¯å¦åŒ…å«JSON: {'[' in result and ']' in result}")
        print(f"   æ˜¯å¦ä¸ºç©º: {result.strip() == ''}")
        print(f"   æ˜¯å¦åªæœ‰ç©ºæ ¼: {result.strip() == ''}")
        print(f"   å‰50ä¸ªå­—ç¬¦: '{result[:50]}'")
        print(f"   å50ä¸ªå­—ç¬¦: '{result[-50:]}'")


if __name__ == "__main__":
    asyncio.run(debug_ai_response())
